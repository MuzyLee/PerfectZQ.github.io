
## MongoDB 数据库/表备份

**注意！ 以下的命令不是在 Mongo Shell 中执行的命令，而是在 Linux shell 中执行的命令**

### 数据库备份 mongodump
```
mongodump -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -o 文件存在路径 
# 如果没有设置用户名和密码，可以去掉-u和-p。
# 如果导出本机的数据库，可以去掉-h。	
# 如果是默认端口，可以去掉--port。
# 如果想导出所有数据库，可以去掉-d。
	
# 例如导出所有数据库：
mongodump /usr/zhangqiang/mongodb/
```
### 通过备份还原数据库	mongorestore
```
mongorestore -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 --drop 文件存在路径

# 参数说明
    
    --drop # 先删除所有的记录，然后恢复

# 例如恢复所有数据库：	
    
    mongorestore /usr/zhangqiang/mongodb/	

# 恢复指定的数据库
    
    mongorestore -d test /usr/zhangqiang/mongodb/test/
```
### 导出表/表中某些字段  mongoexport
```
mongoexport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 -f 字段 -q 条件导出 --type=csv -o 文件名

# 参数说明
    
    -f          # 导出指定字段，以逗号分割，-f name,email,age导出name,email,age这三个字段
    -q          # 可以根查询条件导出，-q '{ "uid" : "100" }' 导出uid为100的数据	
    --type=csv  # 表示导出的文件格式为csv的，这个比较有用，因为大部分的关系型数据库都是支持csv，在这里有共同点

# 例如导出表 visit_data

    mongoexport  -d smarket -c visit_vector  -o /usr/zhangqiang/mongodb/smarket/visit_vector.dat	

# 导出部分字段 _id,school,teacher

    mongoexport -d smarket -c visit_vector --type=csv -f _id,school,teacher -o /usr/zhangqiang/mongodb/smarket/visit_vector.csv
```
### 导入表/表中某些字段  mongoimport
```
# 还原整表导出的非csv文件

    mongoimport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 --upsert --drop 文件名

# 参数说明

    --upsert # 插入或者更新现有数据

# 例如：

    mongoimport -d smarket -c visit_vector visit_vector.dat

# 还原部分字段的导出文件
    
    mongoimport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 --upsertFields 字段 --drop 文件名  

    --upsertFields # 与 --upsert 一样

# 还原导出的csv文件

    mongoimport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 --type 类型 --headerline --upsert --drop 文件名

    --headerline # csv 文件第一行为列名
```
	

##	MongoDB 数据库/表节点之间的数据复制 	  

MongoDB自带了clone一族JavaScript函数来进行数据的复制,这里我们总结了MongoDB在不同主机间复制数据库和集合的教程,列举出了一些主从复制操作中常用的重要函数:
**以下的命令是在 Mongo Shell 中执行的命令**

### 在不同的mongodb实例间复制数据
```
db.cloneCollection(from, collection, query)

# 参数说明

    from:string  		# 包含需要复制的表的mongodb实例主机名
    collection:string           # 数据实例中需要复制的表名，该命令只可以复制远程mongodb实例上相同数据库名称的表
    query:document 		# 可选的选项。标准的查询语句过滤掉不需要的文档
		
# 例如：

    db.cloneCollection("10.4.120.83", "visit_data", {"school" : "第一实验小学"})
```
### 复制远程主机的数据库到本地，该命令假设远程mongodb实例中拥有与本地相同的数据库名称。
```
db.cloneDatabase(hostname)

# 参数说明

    hostname:string  	# 包含需要复制的数据库的mongodb实例主机名
			
# 例如：
    
    use smarket
    db.dropDatabase();
    db.cloneDatabase("10.4.120.83");
```
### 从远程主机复制数据库到本地，或从本地复制数据库到远程主机
```	
db.copyDatabase(fromdb, todb, fromhost, username, password, mechanism)
		
# 参数说明

    fromdb:string  	# 源数据库名称
    todb:string  	# 目标数据库名称
    fromhost:string  	# 可选项，源数据库的主机名。如果是同一主机，忽略该选项
    username:string  	# 可选项，源主机名用户名
    password:string  	# 可选项，源主机名用户名对应密码
    mechanism:string	# 可选项，3.0版本新出的选项，在源数据库主机上验证用户名和密码的机制。MONGODB-CR 或者 SCRAM-SHA-1，
			# 如果 MongoDB 的版本号为3.0及以上，默认为 SCRAM-SHA-1，否则默认为 MONGODB-CR
			# 从装有3.0版本或以上的数据库实例复制到装有2.6.x版本数据库的主机时指定MONGODB-CR来验证。
			# 例如拷贝一个强制进行验证的mongod实例的数据库

```
